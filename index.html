import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';

// --- ICONS ---
const SVGIcons = {
  pos: ( <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2H2v10l9.29 9.29a1 1 0 0 0 1.41 0L22 12.41a1 1 0 0 0 0-1.41L12 2z"></path><path d="M7 7h.01"></path></svg> ),
  dashboard: ( <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8a6 6 0 0 0-8.37-8.37"/><path d="M11 11a2 2 0 1 0-2.83-2.83"/></svg> ),
  plus: ( <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> ),
  minus: ( <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg> ),
  trash: ( <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> ),
  search: ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> ),
  close: ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> ),
  hold: ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h.01"/><path d="M12 4v10"/><path d="M12 14l-4-4"/><path d="M12 14l4-4"/></svg> ),
  bills: ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 10h18M3 6h18M3 14h18M3 18h18"/></svg> )
};

// --- HELPER FUNCTIONS ---
const parseCSV = (csvText) => {
  const lines = csvText.trim().split('\n');
  if (lines.length < 2) return [];
  const headerLine = lines[0].split(',').map(h => h.trim());
  const headerMapping = { 'รหัสสินค้า': 'id', 'ชื่อการค้า': 'name', 'หน่วย': 'unit', 'บาร์โค้ด': 'barcode', 'ราคา': 'price', 'คงเหลือ': 'stock', 'ต้นทุน': 'cost', 'หมวดหมู่': 'category' };
  const headerIndices = {};
  Object.keys(headerMapping).forEach(thaiHeader => {
    const index = headerLine.indexOf(thaiHeader);
    if (index !== -1) headerIndices[headerMapping[thaiHeader]] = index;
  });
  return lines.slice(1).map(line => {
    const values = line.split(',');
    const product = {};
    Object.keys(headerIndices).forEach(englishKey => {
      const index = headerIndices[englishKey];
      product[englishKey] = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
    });
    product.image = `https://placehold.co/200x200/e0e7ff/4338ca?text=${encodeURIComponent(product.name || 'Product')}`;
    product.category = product.category || 'ทั่วไป';
    product.name_lowercase = product.name.toLowerCase();
    return product;
  }).filter(p => p.id && p.name && p.price);
};

function useDebounce(value, delay) {
    const [debouncedValue, setDebouncedValue] = useState(value);
    useEffect(() => {
        const handler = setTimeout(() => { setDebouncedValue(value); }, delay);
        return () => { clearTimeout(handler); };
    }, [value, delay]);
    return debouncedValue;
}

// --- COMPONENTS ---

const ProductCard = React.memo(({ product, onAddToCart }) => {
    const stock = parseInt(product.stock, 10) || 0;
    const hasStock = stock > 0;
    return (
        <div onClick={() => hasStock && onAddToCart(product)} className={`relative border rounded-lg flex flex-col items-center justify-center p-2 text-center transition-all duration-200 ${hasStock ? 'cursor-pointer hover:border-indigo-500 hover:shadow-lg' : 'opacity-50 bg-gray-100'}`}>
            <img src={product.image} alt={product.name} className="w-20 h-20 object-cover mb-2 rounded-md" />
            <p className="text-sm font-semibold text-gray-700 leading-tight h-10">{product.name}</p>
            <p className="text-md font-bold text-indigo-600">{parseFloat(product.price).toLocaleString('th-TH')} ฿</p>
            {!hasStock && <div className="absolute inset-0 bg-white bg-opacity-70 flex items-center justify-center"><span className="font-bold text-red-500">สินค้าหมด</span></div>}
        </div>
    );
});

const SalePanel = React.memo(({ cart, onUpdateQuantity, onRemoveItem, onHoldBill, onCheckout }) => {
    const { subtotal } = useMemo(() => cart.items.reduce((acc, item) => ({ subtotal: acc.subtotal + (parseFloat(item.price) || 0) * item.quantity }), { subtotal: 0 }), [cart.items]);
    return (
        <div className="bg-white h-full flex flex-col shadow-lg rounded-lg">
            <div className="p-4 border-b flex justify-between items-center"><h2 className="text-xl font-bold text-gray-800">บิลปัจจุบัน</h2><button onClick={onHoldBill} disabled={cart.items.length === 0} className="flex items-center gap-2 bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-3 rounded-lg text-sm disabled:bg-gray-300"> {SVGIcons.hold} <span>พักบิล</span></button></div>
            <div className="flex-grow overflow-y-auto p-4">{cart.items.length === 0 ? (<div className="flex h-full items-center justify-center"><p className="text-gray-400">ยังไม่มีรายการขาย</p></div>) : (cart.items.map(item => (<div key={item.id} className="grid grid-cols-12 gap-2 items-center mb-3"><div className="col-span-6"><p className="font-semibold text-gray-700 truncate">{item.name}</p></div><div className="col-span-3 flex items-center"><button onClick={() => onUpdateQuantity(item.id, item.quantity - 1)} className="p-1 rounded-full bg-gray-200 hover:bg-gray-300">{SVGIcons.minus}</button><span className="w-8 text-center font-mono">{item.quantity}</span><button onClick={() => onUpdateQuantity(item.id, item.quantity + 1)} className="p-1 rounded-full bg-gray-200 hover:bg-gray-300">{SVGIcons.plus}</button></div><div className="col-span-2 text-right"><p className="font-semibold">{(parseFloat(item.price) * item.quantity).toFixed(2)}</p></div><div className="col-span-1 text-right"><button onClick={() => onRemoveItem(item.id)} className="text-red-400 hover:text-red-600">{SVGIcons.trash}</button></div></div>)))}</div>
            <div className="p-4 bg-gray-50 border-t rounded-b-lg"><div className="flex justify-between items-center text-2xl font-bold mb-4"><span>ยอดสุทธิ:</span><span className="text-indigo-600">{subtotal.toLocaleString('th-TH', { minimumFractionDigits: 2 })} ฿</span></div><button onClick={onCheckout} disabled={cart.items.length === 0} className="w-full bg-indigo-600 text-white py-4 rounded-lg hover:bg-indigo-700 text-lg font-bold disabled:bg-gray-300">ชำระเงิน (F2)</button></div>
        </div>
    );
});

const PaymentModal = ({ isOpen, onClose, total, onConfirm }) => {
    const [paymentMethod, setPaymentMethod] = useState('cash');
    const [cashReceived, setCashReceived] = useState('');
    const cashReceivedRef = useRef(null);
    useEffect(() => { if (isOpen) { setTimeout(() => cashReceivedRef.current?.focus(), 100); setCashReceived(''); setPaymentMethod('cash'); } }, [isOpen]);
    if (!isOpen) return null;
    const cash = parseFloat(cashReceived) || 0;
    const change = cash >= total ? cash - total : 0;
    const handleConfirm = () => onConfirm({ paymentMethod, total, cashReceived: cash, change });
    return (<div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50"><div className="bg-white rounded-lg shadow-2xl w-full max-w-lg"><div className="p-4 border-b flex justify-between items-center"><h2 className="text-xl font-bold">ชำระเงิน</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-800">{SVGIcons.close}</button></div><div className="p-6"><div className="text-center mb-4"><p className="text-gray-600">ยอดรวม</p><p className="text-5xl font-bold text-indigo-600 my-2">{total.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</p></div><div className="grid grid-cols-3 gap-2 mb-4"><button onClick={() => setPaymentMethod('cash')} className={`p-3 rounded-lg border-2 ${paymentMethod === 'cash' ? 'border-indigo-500 bg-indigo-50' : ''}`}>เงินสด</button><button onClick={() => setPaymentMethod('qr')} className={`p-3 rounded-lg border-2 ${paymentMethod === 'qr' ? 'border-indigo-500 bg-indigo-50' : ''}`}>QR/โอน</button><button onClick={() => setPaymentMethod('card')} className={`p-3 rounded-lg border-2 ${paymentMethod === 'card' ? 'border-indigo-500 bg-indigo-50' : ''}`}>บัตรเครดิต</button></div>{paymentMethod === 'cash' && (<><div className="mb-2"><label className="block text-gray-700">รับเงินมา</label><input ref={cashReceivedRef} type="number" value={cashReceived} onChange={(e) => setCashReceived(e.target.value)} className="w-full text-2xl p-3 border rounded-lg text-center" placeholder="0.00" /></div><div className="text-center"><p className="text-gray-600">เงินทอน</p><p className="text-4xl font-bold text-green-600 my-1">{change.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</p></div></>)}</div><div className="p-4 bg-gray-50 rounded-b-lg"><button onClick={handleConfirm} disabled={paymentMethod === 'cash' && cash < total} className="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 text-lg font-bold disabled:bg-gray-400">ยืนยัน</button></div></div></div>);
};

const ReceiptModal = ({ isOpen, onClose, saleData }) => {
    if (!isOpen || !saleData) return null;
    return (<div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50"><div className="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm text-center"><h2 className="text-2xl font-bold mb-4">การขายสำเร็จ</h2><div className="border-t border-b py-4 my-4 text-left space-y-1"><p className="font-bold"><strong>ยอดสุทธิ:</strong> {saleData.total.toLocaleString('th-TH', { minimumFractionDigits: 2 })} ฿</p>{saleData.paymentMethod === 'cash' && <p className="font-bold text-green-600"><strong>เงินทอน:</strong> {saleData.change.toLocaleString('th-TH', { minimumFractionDigits: 2 })} ฿</p>}</div><button onClick={onClose} className="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 text-lg font-bold">เริ่มการขายใหม่</button></div></div>);
};

const StatCard = ({ title, value, isLoading }) => (
    <div className="bg-white p-6 rounded-lg shadow"><h3 className="text-sm font-medium text-gray-500">{title}</h3>{isLoading ? <div className="h-8 mt-1 bg-gray-200 rounded animate-pulse w-3/4"></div> : <p className="mt-1 text-3xl font-semibold text-gray-900">{value}</p>}</div>
);

const SalesChart = ({ data, isLoading }) => {
    const maxValue = Math.max(...data.map(d => d.sales), 1);
    return (<div className="bg-white p-6 rounded-lg shadow"><h3 className="text-lg font-medium text-gray-800 mb-4">ยอดขาย 7 วันล่าสุด</h3><div className="h-64 flex items-end justify-around space-x-2">{isLoading ? [...Array(7)].map((_, i) => <div key={i} className="flex-1 bg-gray-200 rounded-t-lg animate-pulse" style={{ height: `${Math.random() * 80 + 10}%` }}></div>) : data.map(day => (<div key={day.date} className="flex-1 flex flex-col items-center"><div className="w-full bg-indigo-200 rounded-t-lg hover:bg-indigo-400" style={{ height: `${(day.sales / maxValue) * 100}%` }}></div><span className="text-xs text-gray-500 mt-1">{day.date}</span></div>))}</div></div>);
};

const TopProducts = ({ data, isLoading }) => (
    <div className="bg-white p-6 rounded-lg shadow"><h3 className="text-lg font-medium text-gray-800 mb-4">5 สินค้าขายดี</h3><div className="space-y-4">{isLoading ? [...Array(5)].map((_, i) => <div key={i} className="flex justify-between"><div className="h-5 bg-gray-200 rounded w-1/2 animate-pulse"></div><div className="h-5 bg-gray-200 rounded w-1/4 animate-pulse"></div></div>) : data.map(p => (<div key={p.name} className="flex justify-between"><span className="text-gray-700">{p.name}</span><span className="font-semibold">{p.quantity} ชิ้น</span></div>))}</div></div>
);

// --- VIEWS ---

const PosView = ({ allProducts, activeCart, heldCarts, handleAddToCart, handleUpdateQuantity, handleRemoveItem, handleHoldBill, handleResumeBill, handleCheckout }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const debouncedSearchTerm = useDebounce(searchTerm, 300);
    const [searchResults, setSearchResults] = useState([]);
    const [isSearching, setIsSearching] = useState(false);
    const searchInputRef = useRef(null);

    useEffect(() => {
        if (!debouncedSearchTerm) { setSearchResults([]); return; }
        setIsSearching(true);
        const lowercasedTerm = debouncedSearchTerm.toLowerCase();
        const results = allProducts.filter(p => p.name_lowercase.includes(lowercasedTerm) || (p.barcode && p.barcode.includes(debouncedSearchTerm)));
        setSearchResults(results);
        setIsSearching(false);
    }, [debouncedSearchTerm, allProducts]);

    return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
            <div className="lg:col-span-1 h-full"><SalePanel cart={activeCart} onUpdateQuantity={handleUpdateQuantity} onRemoveItem={handleRemoveItem} onHoldBill={handleHoldBill} onCheckout={handleCheckout} /></div>
            <div className="lg:col-span-2 bg-white shadow-lg rounded-lg flex flex-col h-full">
                <div className="p-4 border-b"><div className="relative"><input ref={searchInputRef} type="text" placeholder="ค้นหาสินค้า (F1)..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 border rounded-lg" /><div className="absolute top-0 left-0 pl-3 pt-2.5 text-gray-400">{SVGIcons.search}</div></div></div>
                <div className="flex-grow overflow-y-auto p-4">
                    {isSearching ? <p>กำลังค้นหา...</p> : debouncedSearchTerm && searchResults.length === 0 ? <p>ไม่พบสินค้าที่ตรงกัน</p> : !debouncedSearchTerm ? <p className="text-gray-500 text-center mt-10">กรุณาค้นหาเพื่อแสดงรายการสินค้า</p> : (<div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">{searchResults.map(p => <ProductCard key={p.id} product={p} onAddToCart={handleAddToCart} />)}</div>)}
                </div>
                {heldCarts.length > 0 && <div className="p-2 border-t bg-gray-50 flex items-center gap-2 overflow-x-auto"><span className="font-bold text-sm flex items-center gap-2">{SVGIcons.bills} บิลที่พัก:</span>{heldCarts.map((cart, i) => <button key={cart.id} onClick={() => handleResumeBill(cart.id)} className="bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full text-sm hover:bg-yellow-300 whitespace-nowrap">บิล {i+1} ({cart.items.reduce((t,i)=>t+i.quantity,0)} ชิ้น)</button>)}</div>}
            </div>
        </div>
    );
};

const DashboardView = ({ firebase, appId }) => {
    const [stats, setStats] = useState({ todaySales: 0, todayTx: 0, avgSale: 0 });
    const [chartData, setChartData] = useState([]);
    const [topProducts, setTopProducts] = useState([]);
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        if (!firebase) return;
        const fetchData = async () => {
            setIsLoading(true);
            const { db, collection, getDocs, query, where } = firebase;
            const salesCollectionRef = collection(db, `/artifacts/${appId}/public/data/pos_sales`);
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const q = query(salesCollectionRef, where("createdAt", ">=", today));
            const querySnapshot = await getDocs(q);
            
            let todaySales = 0;
            let todayTx = 0;
            querySnapshot.forEach(doc => {
                todaySales += doc.data().total;
                todayTx++;
            });
            setStats({ todaySales, todayTx, avgSale: todayTx > 0 ? todaySales / todayTx : 0 });

            const allSalesSnapshot = await getDocs(collection(db, `/artifacts/${appId}/public/data/pos_sales`));
            const salesByDay = {};
            const productCount = {};

            allSalesSnapshot.forEach(doc => {
                const sale = doc.data();
                const date = sale.createdAt.toDate().toLocaleDateString('th-TH', { day: '2-digit', month: 'short' });
                salesByDay[date] = (salesByDay[date] || 0) + sale.total;

                sale.items.forEach(item => {
                    productCount[item.name] = (productCount[item.name] || 0) + item.quantity;
                });
            });

            const chartData = Object.entries(salesByDay).slice(-7).map(([date, sales]) => ({ date, sales }));
            setChartData(chartData);

            const topProducts = Object.entries(productCount).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([name, quantity]) => ({ name, quantity }));
            setTopProducts(topProducts);

            setIsLoading(false);
        };
        fetchData();
    }, [firebase, appId]);

    return (
        <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <StatCard title="ยอดขายวันนี้" value={stats.todaySales.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })} isLoading={isLoading} />
                <StatCard title="จำนวนบิลวันนี้" value={stats.todayTx.toLocaleString('th-TH')} isLoading={isLoading} />
                <StatCard title="ยอดเฉลี่ยต่อบิล" value={stats.avgSale.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })} isLoading={isLoading} />
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div className="lg:col-span-3"><SalesChart data={chartData} isLoading={isLoading} /></div>
                <div className="lg:col-span-2"><TopProducts data={topProducts} isLoading={isLoading} /></div>
            </div>
        </div>
    );
};


// --- MAIN APP ---
export default function App() {
  const [firebase, setFirebase] = useState(null);
  const [allProducts, setAllProducts] = useState([]);
  const [activeCart, setActiveCart] = useState({ id: 'active', items: [] });
  const [heldCarts, setHeldCarts] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isImporting, setIsImporting] = useState(false);
  const [error, setError] = useState(null);
  const [modal, setModal] = useState({ payment: false, receipt: false });
  const [lastSaleData, setLastSaleData] = useState(null);
  const [activeView, setActiveView] = useState('pos');

  const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTT3t_8Hx7WcD8uUi2IGt1zDbOMB3MSK57dYnfqrrut3do_Gw2hzYSG9IBIEg8fg7uTEL2sVq-IfVJR/pub?output=csv';
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pos-app';

  useEffect(() => {
    const initFirebase = async () => {
      try {
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
        const { getAuth, signInAnonymously, signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
        const { getFirestore, collection, getDocs, writeBatch, doc, runTransaction, query, where } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth);
        setFirebase({ db, auth, collection, getDocs, writeBatch, doc, runTransaction, query, where });
      } catch (err) { setError("เกิดข้อผิดพลาดในการเริ่มต้นระบบ Firebase"); setIsLoading(false); }
    };
    initFirebase();
  }, []);

  const importProductsFromSheet = useCallback(async () => {
    if (!firebase) return;
    setIsImporting(true);
    const { db, collection, writeBatch, doc } = firebase;
    const productCollectionRef = collection(db, `/artifacts/${appId}/public/data/pos_products`);
    try {
        const response = await fetch(DATA_URL); if (!response.ok) throw new Error('Cannot fetch sheet');
        const csvText = await response.text(); const parsedProducts = parseCSV(csvText);
        const batch = writeBatch(db);
        parsedProducts.forEach(product => {
            const docRef = doc(productCollectionRef, product.id);
            batch.set(docRef, { ...product, price: parseFloat(product.price) || 0, stock: parseInt(product.stock, 10) || 0, cost: parseFloat(product.cost) || 0 });
        });
        await batch.commit();
    } catch (e) { setError("ไม่สามารถนำเข้าข้อมูลสินค้าได้"); } 
    finally { setIsImporting(false); }
  }, [firebase, appId]);

  useEffect(() => {
      if (!firebase) return;
      const { db, collection, getDocs } = firebase;
      const productCollectionRef = collection(db, `/artifacts/${appId}/public/data/pos_products`);
      const loadInitialData = async () => {
          setIsLoading(true);
          const snapshot = await getDocs(productCollectionRef);
          if (snapshot.empty) {
              await importProductsFromSheet();
              const finalSnapshot = await getDocs(productCollectionRef);
              setAllProducts(finalSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          } else {
              setAllProducts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          }
          setIsLoading(false);
      };
      loadInitialData();
  }, [firebase, appId, importProductsFromSheet]);

  const handleAddToCart = useCallback((product) => {
    setActiveCart(prevCart => {
        const newItems = [...prevCart.items];
        const existing = newItems.find(item => item.id === product.id);
        const currentStock = allProducts.find(p => p.id === product.id)?.stock || 0;
        if (existing) { if (existing.quantity < currentStock) existing.quantity++; } 
        else { if (currentStock > 0) newItems.push({ ...product, quantity: 1 }); }
        return { ...prevCart, items: newItems };
    });
  }, [allProducts]);
  
  const handleUpdateQuantity = useCallback((id, newQty) => {
    if (newQty <= 0) { handleRemoveItem(id); return; }
    const product = allProducts.find(p => p.id === id);
    if (newQty > product?.stock) return;
    setActiveCart(prev => ({...prev, items: prev.items.map(item => item.id === id ? { ...item, quantity: newQty } : item)}));
  }, [allProducts]);

  const handleRemoveItem = useCallback((id) => { setActiveCart(prev => ({...prev, items: prev.items.filter(item => item.id !== id)})); }, []);
  const handleHoldBill = useCallback(() => { if (activeCart.items.length === 0) return; const newHeldCart = { ...activeCart, id: Date.now() }; setHeldCarts(prev => [...prev, newHeldCart]); setActiveCart({ id: 'active', items: [] }); }, [activeCart]);
  const handleResumeBill = useCallback((cartId) => { const billToResume = heldCarts.find(c => c.id === cartId); if (!billToResume) return; if (activeCart.items.length > 0) { alert("กรุณาพักบิลปัจจุบันก่อนเรียกบิลอื่น"); return; } setActiveCart(billToResume); setHeldCarts(prev => prev.filter(c => c.id !== cartId)); }, [heldCarts, activeCart.items]);
  const handleCheckout = useCallback(() => setModal(prev => ({ ...prev, payment: true })), []);

  const handleConfirmPayment = useCallback(async (paymentData) => {
      if (!firebase) return;
      const { db, runTransaction, doc, collection, writeBatch } = firebase;
      const saleItems = activeCart.items;
      try {
          await runTransaction(db, async (transaction) => {
              // --- READ PHASE ---
              // First, read all product documents to check stock.
              const productRefs = saleItems.map(item => doc(db, `/artifacts/${appId}/public/data/pos_products`, item.id));
              const productDocs = await Promise.all(productRefs.map(ref => transaction.get(ref)));
              
              const updates = [];
              for (let i = 0; i < productDocs.length; i++) {
                  const productDoc = productDocs[i];
                  const item = saleItems[i];
                  if (!productDoc.exists()) {
                      throw new Error(`สินค้า ${item.name} ไม่พบในฐานข้อมูล`);
                  }
                  const currentStock = productDoc.data().stock;
                  const newStock = currentStock - item.quantity;
                  if (newStock < 0) {
                      throw new Error(`สินค้า ${item.name} ไม่เพียงพอ (เหลือ ${currentStock} ชิ้น)`);
                  }
                  updates.push({ ref: productRefs[i], newStock });
              }

              // --- WRITE PHASE ---
              // If all checks pass, perform all updates.
              updates.forEach(update => {
                  transaction.update(update.ref, { stock: update.newStock });
              });
          });
          
          const saleId = Date.now().toString();
          const salesCollection = collection(db, `/artifacts/${appId}/public/data/pos_sales`);
          const saleDoc = doc(salesCollection, saleId);
          const batch = writeBatch(db);
          batch.set(saleDoc, { ...paymentData, items: saleItems, createdAt: new Date() });
          await batch.commit();
          setLastSaleData({ ...paymentData });
          setModal({ payment: false, receipt: true });
      } catch (e) { setError(`เกิดข้อผิดพลาด: ${e.message}`); }
  }, [firebase, activeCart.items, appId]);

  const handleNewSale = useCallback(() => { setModal({ payment: false, receipt: false }); setActiveCart({ id: 'active', items: [] }); }, []);
  const totalForPayment = useMemo(() => activeCart.items.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0), [activeCart.items]);

  return (
    <div className="bg-gray-100 h-screen font-sans flex">
        <nav className="w-20 bg-indigo-800 text-white flex flex-col items-center p-4 space-y-6">
            <button onClick={() => setActiveView('pos')} className={`p-3 rounded-lg ${activeView === 'pos' ? 'bg-indigo-600' : 'hover:bg-indigo-700'}`}>{SVGIcons.pos}</button>
            <button onClick={() => setActiveView('dashboard')} className={`p-3 rounded-lg ${activeView === 'dashboard' ? 'bg-indigo-600' : 'hover:bg-indigo-700'}`}>{SVGIcons.dashboard}</button>
        </nav>
        <div className="flex-1 flex flex-col">
            <header className="bg-white shadow-sm z-10"><div className="container mx-auto px-4 py-4"><h1 className="text-xl font-bold text-gray-800">{activeView === 'pos' ? 'หน้าขาย (POS)' : 'แดชบอร์ด'}</h1></div></header>
            <main className="flex-grow container mx-auto p-4">
                {isLoading || isImporting ? <div className="text-center mt-10">{isImporting ? "กำลังนำเข้าข้อมูลสินค้าครั้งแรก..." : "กำลังโหลดข้อมูล..."}</div> :
                 error ? <div className="text-red-500 text-center mt-10">{error}</div> :
                 activeView === 'pos' ? <PosView allProducts={allProducts} activeCart={activeCart} heldCarts={heldCarts} handleAddToCart={handleAddToCart} handleUpdateQuantity={handleUpdateQuantity} handleRemoveItem={handleRemoveItem} handleHoldBill={handleHoldBill} handleResumeBill={handleResumeBill} handleCheckout={handleCheckout} /> : 
                 <DashboardView firebase={firebase} appId={appId} />}
            </main>
        </div>
        <PaymentModal isOpen={modal.payment} onClose={() => setModal(prev => ({ ...prev, payment: false }))} total={totalForPayment} onConfirm={handleConfirmPayment} />
        <ReceiptModal isOpen={modal.receipt} onClose={handleNewSale} saleData={lastSaleData} />
    </div>
  );
}
